<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<title>Messages</title>

<style>
:root{
  --bg:#f2f2f7;
  --header:rgba(255,255,255,.72);
  --border:rgba(60,60,67,.18);
  --text:#111;
  --muted:rgba(60,60,67,.65);

  --in:#e5e5ea;
  --out1:#0a84ff;
  --out2:#007aff;

  --shadow:0 14px 40px rgba(0,0,0,.14);
  --shadow2:0 8px 20px rgba(0,0,0,.12);

  --safe-bottom: env(safe-area-inset-bottom);
  --safe-top: env(safe-area-inset-top);
}

@media (prefers-color-scheme: dark){
  :root{
    --bg:#000;
    --header:rgba(28,28,30,.70);
    --border:rgba(84,84,88,.35);
    --text:#fff;
    --muted:rgba(235,235,245,.65);
    --in:#2c2c2e;

    --shadow:0 14px 40px rgba(0,0,0,.45);
    --shadow2:0 8px 20px rgba(0,0,0,.35);
  }
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Helvetica,Arial;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
}

/* iPhone frame (desktop) */
.phone{min-height:100%;display:flex;justify-content:center;padding:18px 12px}
.wrap{
  width:100%;
  max-width:430px;
  min-height:calc(100dvh - 36px);
  background:var(--bg);
  border-radius:34px;
  overflow:hidden;
  box-shadow:var(--shadow);
  position:relative;
  border:1px solid rgba(120,120,128,.22);
}
.wrap:before{
  content:"";
  position:absolute; inset:-2px;
  border-radius:36px;
  pointer-events:none;
  background:linear-gradient(135deg,
    rgba(255,255,255,.35),
    rgba(255,255,255,0) 35%,
    rgba(255,255,255,.10) 65%,
    rgba(255,255,255,0)
  );
  mix-blend-mode:overlay;
  opacity:.55;
}
.blob{position:absolute;width:260px;height:260px;filter:blur(28px);opacity:.26;pointer-events:none}
.blob.b1{top:-90px;left:-80px;background:radial-gradient(circle at 30% 30%, #0a84ff, transparent 60%)}
.blob.b2{top:30px;right:-120px;background:radial-gradient(circle at 30% 30%, #ff2d55, transparent 60%)}
.blob.b3{bottom:80px;left:-120px;background:radial-gradient(circle at 30% 30%, #34c759, transparent 60%)}
.notch{
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  width:160px; height:28px; border-radius:999px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.12);
  z-index:30; display:none;
}
@media (min-width:521px){ .notch{display:block} }
@media (prefers-color-scheme: dark){
  .notch{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.10)}
}
@media (max-width:520px){
  .phone{padding:0}
  .wrap{max-width:100%;min-height:100dvh;border-radius:0;box-shadow:none;border:none}
  .wrap:before,.blob,.notch{display:none}
}

/* header */
.header{
  position:sticky; top:0; z-index:20;
  backdrop-filter: blur(18px) saturate(180%);
  -webkit-backdrop-filter: blur(18px) saturate(180%);
  background:var(--header);
  border-bottom:1px solid var(--border);
}
.statusbar{height:calc(10px + var(--safe-top))}
.header-inner{padding:10px 14px 12px;display:flex;align-items:center;gap:10px}
.back{
  width:34px;height:34px;border-radius:12px;
  display:grid;place-items:center;
  border:1px solid var(--border);
  background:rgba(255,255,255,.35);
  color:var(--text);
  flex:0 0 auto;
  transition:transform .12s ease;
}
@media (prefers-color-scheme: dark){ .back{background:rgba(255,255,255,.06)} }
.back:active{transform:scale(.98)}
.back svg{width:16px;height:16px;opacity:.9}

.avatar{
  width:38px;height:38px;border-radius:19px;
  background:linear-gradient(135deg,#0a84ff,#ff2d55);
  box-shadow:var(--shadow2);
  position:relative;
  flex:0 0 auto;
}
.avatar:after{
  content:""; position:absolute; inset:-1px;
  border-radius:20px;
  background:linear-gradient(135deg, rgba(255,255,255,.55), rgba(255,255,255,0));
  opacity:.35; pointer-events:none;
}
.title{min-width:0;display:flex;flex-direction:column;line-height:1.12}
.title strong{
  font-size:16px;font-weight:800;letter-spacing:-.2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.title span{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badges{margin-left:auto;display:flex;gap:8px}
.badge{
  height:30px;padding:0 10px;border-radius:999px;
  border:1px solid var(--border);
  display:flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.35);
  font-size:12px;color:var(--muted);
}
@media (prefers-color-scheme: dark){ .badge{background:rgba(255,255,255,.06)} }
.dot{width:7px;height:7px;border-radius:99px;background:#34c759;box-shadow:0 0 0 3px rgba(52,199,89,.18)}

/* chat */
.chat{
  padding:14px 12px 180px;
  background:
    radial-gradient(circle at 20% 0%, rgba(10,132,255,.12), transparent 42%),
    radial-gradient(circle at 90% 12%, rgba(255,45,85,.10), transparent 46%),
    radial-gradient(circle at 40% 90%, rgba(52,199,89,.08), transparent 40%),
    var(--bg);
  overflow:auto;
  height:calc(100dvh - 140px);
}
@media (min-width:521px){
  .chat{height:calc(100dvh - 170px)}
}

.meta{display:flex;justify-content:center;margin:10px 0 8px;font-size:12px;color:var(--muted)}
.pill{
  padding:7px 12px;border-radius:999px;
  background:rgba(120,120,128,.12);
  border:1px solid rgba(120,120,128,.18);
  display:flex;align-items:center;gap:6px;
}
.pill svg{width:14px;height:14px;opacity:.8}

.time{
  display:flex;justify-content:center;
  font-size:12px;color:var(--muted);
  margin:12px 0 6px;
}
.row{display:flex;margin:10px 0;align-items:flex-end}
.row.in{justify-content:flex-start}
.row.out{justify-content:flex-end}

.bubble{
  max-width:86%;
  padding:12px 14px;
  border-radius:20px;
  font-size:16px;
  line-height:1.33;
  box-shadow:0 2px 14px rgba(0,0,0,.08);
  transform:translateY(6px);
  opacity:0;
  animation:pop .28s ease forwards;
  position:relative;
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
}
@keyframes pop{to{transform:translateY(0);opacity:1}}
.bubble.in{background:var(--in);border-bottom-left-radius:7px}
.bubble.out{
  background:linear-gradient(135deg,var(--out1),var(--out2));
  color:#fff;border-bottom-right-radius:7px;overflow:hidden;
}
.bubble.out:before{
  content:""; position:absolute; inset:-40px;
  background:radial-gradient(circle at 30% 20%, rgba(255,255,255,.35), transparent 35%);
  transform:rotate(10deg); opacity:.6;
}

/* reaction badge */
.reaction{
  position:absolute;
  bottom:-10px;
  right:8px;
  height:22px;
  padding:0 8px;
  border-radius:999px;
  border:1px solid rgba(120,120,128,.22);
  background:rgba(255,255,255,.78);
  display:none;
  align-items:center;
  gap:6px;
  box-shadow:0 4px 16px rgba(0,0,0,.12);
  font-size:13px;
  color:#111;
}
@media (prefers-color-scheme: dark){
  .reaction{background:rgba(28,28,30,.82);color:#fff;border-color:rgba(255,255,255,.12)}
}

/* typing */
.typing{
  display:inline-flex;gap:4px;
  padding:10px 12px;border-radius:999px;
  background:rgba(120,120,128,.12);
  border:1px solid rgba(120,120,128,.18);
}
.typing i{
  width:6px;height:6px;border-radius:99px;
  background:rgba(60,60,67,.45);
  display:inline-block;
  animation:bounce 1.1s infinite ease-in-out;
}
.typing i:nth-child(2){animation-delay:.15s}
.typing i:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.5}40%{transform:translateY(-4px);opacity:1}}

/* composer */
.composer{
  position:fixed;left:0;right:0;bottom:0;z-index:40;
  background:var(--header);
  backdrop-filter: blur(18px) saturate(180%);
  -webkit-backdrop-filter: blur(18px) saturate(180%);
  border-top:1px solid var(--border);
  padding-bottom:calc(10px + var(--safe-bottom));
}
.composer-inner{
  max-width:430px;margin:0 auto;
  padding:10px 12px;
  display:flex;align-items:flex-end;gap:10px;
}
.plus{
  width:42px;height:42px;border:none;border-radius:999px;
  background:rgba(120,120,128,.14);
  border:1px solid rgba(120,120,128,.18);
  display:grid;place-items:center;color:var(--text);
}
.plus svg{width:18px;height:18px;opacity:.85}
@media (prefers-color-scheme: dark){ .plus{background:rgba(255,255,255,.06)} }

.input{
  flex:1;border:1px solid var(--border);
  border-radius:999px;padding:10px 12px;
  background:rgba(255,255,255,.55);
  box-shadow:0 2px 12px rgba(0,0,0,.08);
}
@media (prefers-color-scheme: dark){ .input{background:rgba(255,255,255,.06)} }

textarea{
  width:100%;border:none;outline:none;font-size:16px;
  resize:none;background:transparent;color:var(--text);line-height:1.25;
}

.btn{
  width:42px;height:42px;border:none;border-radius:999px;
  background:#007aff;color:#fff;display:grid;place-items:center;
  box-shadow:var(--shadow2);
  -webkit-tap-highlight-color: transparent;
  transition:transform .12s ease, filter .12s ease;
}
.btn:active{transform:scale(.98)}
.btn svg{width:18px;height:18px}

/* tapback overlay */
.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.20);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  display:none;
  z-index:60;
}
.tapback{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:120px;
  z-index:70;
  display:none;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(120,120,128,.22);
  background:rgba(255,255,255,.82);
  box-shadow:0 18px 50px rgba(0,0,0,.22);
  gap:10px;
  align-items:center;
}
@media (prefers-color-scheme: dark){
  .tapback{background:rgba(28,28,30,.82);border-color:rgba(255,255,255,.12)}
}
.tapback button{
  border:none;
  background:transparent;
  font-size:20px;
  line-height:1;
  padding:6px 6px;
  border-radius:10px;
}
.tapback button:active{transform:scale(.96)}
.tapback .remove{
  font-size:12px;
  padding:8px 10px;
  border:1px solid rgba(120,120,128,.22);
  border-radius:999px;
  color:var(--muted);
}

/* home indicator */
.home-indicator{
  position:absolute; bottom:12px; left:50%; transform:translateX(-50%);
  width:120px;height:5px;border-radius:999px;
  background:rgba(120,120,128,.35);
  pointer-events:none; z-index:15; display:none;
}
@media (min-width:521px){ .home-indicator{display:block} }
</style>
</head>

<body>
<div class="phone">
  <div class="wrap">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
    <div class="notch" aria-hidden="true"></div>

    <div class="header">
      <div class="statusbar"></div>
      <div class="header-inner">
        <button class="back" type="button" onclick="history.back()" aria-label="Back">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div class="avatar"></div>

        <div class="title">
          <strong id="contactName">Loading‚Ä¶</strong>
          <span id="contactTo"></span>
        </div>

        <div class="badges">
          <div class="badge"><span class="dot"></span><span>Active</span></div>
        </div>
      </div>
    </div>

    <div class="chat" id="chat">
      <div class="meta">
        <div class="pill">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M7 7h10M7 12h10M7 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>Text Message</span>
        </div>
      </div>

      <div id="thread"></div>

      <div class="row in" id="typingRow" style="display:none">
        <div class="typing" aria-label="Typing"><i></i><i></i><i></i></div>
      </div>
    </div>

    <div class="home-indicator"></div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="tapback" id="tapback" role="dialog" aria-label="Reactions">
  <button data-reaction="‚ù§Ô∏è" aria-label="Love">‚ù§Ô∏è</button>
  <button data-reaction="üëç" aria-label="Like">üëç</button>
  <button data-reaction="üëé" aria-label="Dislike">üëé</button>
  <button data-reaction="üòÇ" aria-label="Laugh">üòÇ</button>
  <button data-reaction="‚ÄºÔ∏è" aria-label="Emphasize">‚ÄºÔ∏è</button>
  <button class="remove" data-reaction="" aria-label="Remove reaction">Remove</button>
</div>

<form id="smsForm" class="composer" method="POST" action="https://hook.us1.make.com/ccjgn5ufsliyu7811dulrvhtxq9uehr6">
  <div class="composer-inner">
    <input type="hidden" name="to" id="toInput">
    <input type="hidden" name="from" id="fromInput">
    <input type="hidden" name="sid" id="sidInput">
    <input type="hidden" name="carrier" id="carrierInput">

    <button class="plus" type="button" aria-label="Add">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="input">
      <textarea name="body" rows="1" placeholder="iMessage‚Ä¶"></textarea>
    </div>

    <button class="btn" type="submit" aria-label="Send">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 5l7 7-7 7" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M5 12h13" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>
</form>

<script>
/* =======================
   CONFIG / TEMPLATE
   - DEFAULT always stays as the first bubble
======================= */
const DEFAULTS = {
  firstMsg: "Hey {{name}}, this is Bella with Custom Solar. We noticed a solar permit was submitted in Dallas for your home. Are you fully up and running with your solar system (PTO + monitoring app)? If you‚Äôre good to go, awesome. If not, or if anything feels incomplete, I‚Äôm happy to help you figure out the next step."
};

/* =======================
   TEXTAREA AUTO-GROW
======================= */
const ta = document.querySelector('textarea');
ta.addEventListener('input', () => {
  ta.style.height = 'auto';
  ta.style.height = Math.min(ta.scrollHeight, 120) + 'px';
});

/* =======================
   ROBUST PARAMS
======================= */
function getParamsRobust() {
  if (location.search && location.search.length > 1) return new URLSearchParams(location.search);
  const href = String(location.href || "");
  const qIndex = href.indexOf("?");
  if (qIndex === -1) return new URLSearchParams("");
  const hashIndex = href.indexOf("#", qIndex);
  const queryString = hashIndex === -1 ? href.slice(qIndex) : href.slice(qIndex, hashIndex);
  return new URLSearchParams(queryString);
}

const p = getParamsRobust();
const name = p.get('name') || '';
const to = p.get('to') || '';
const from = p.get('from') || '';
const sid = p.get('sid') || '';
const carrier = p.get('carrier') || '';

/* IMPORTANT:
   - Default message is ALWAYS first.
   - URL response becomes the *reply bubble*.
   - Use msg= (or reply=) to preload a user response bubble.
*/
const urlReply = (p.get('msg') || p.get('reply') || '').trim();

const safeName = name.trim() ? name.trim() : "there";
const firstMessage = DEFAULTS.firstMsg.replaceAll("{{name}}", safeName);

document.title = `Messages ‚Äì ${name || to || 'Unknown'}`;
document.getElementById('contactName').textContent = name || to || 'Unknown';
document.getElementById('contactTo').textContent = to;

document.getElementById('toInput').value = to;
document.getElementById('fromInput').value = from;
document.getElementById('sidInput').value = sid;
document.getElementById('carrierInput').value = carrier;

/* =======================
   THREAD RENDERING (2 bubbles on load)
======================= */
const threadEl = document.getElementById('thread');
const now = new Date();

function cryptoRandomId(){
  if (window.crypto?.getRandomValues){
    const arr = new Uint32Array(2);
    crypto.getRandomValues(arr);
    return arr[0].toString(16) + arr[1].toString(16);
  }
  return Math.random().toString(16).slice(2);
}

function formatTime(d){
  return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
}

function formatDivider(d){
  const isToday = (d.toDateString() === new Date().toDateString());
  const day = isToday ? "Today" : d.toLocaleDateString([], { weekday:'short', month:'short', day:'numeric' });
  return `${day} ${formatTime(d)}`;
}

const messages = [
  { id: cryptoRandomId(), dir: "in",  text: firstMessage, ts: now, reaction: "" }
];

// If URL provides a reply, show it as the user's outgoing bubble
if (urlReply) {
  messages.push({ id: cryptoRandomId(), dir: "out", text: urlReply, ts: new Date(now.getTime() + 15 * 1000), reaction: "" });
}

function renderThread(){
  threadEl.innerHTML = "";

  const divider = document.createElement("div");
  divider.className = "time";
  divider.textContent = formatDivider(messages[0]?.ts || new Date());
  threadEl.appendChild(divider);

  for (const m of messages){
    const row = document.createElement("div");
    row.className = `row ${m.dir}`;

    const bubble = document.createElement("div");
    bubble.className = `bubble ${m.dir}`;
    bubble.dataset.id = m.id;
    bubble.textContent = m.text;

    const reaction = document.createElement("div");
    reaction.className = "reaction";
    if (m.reaction){
      reaction.textContent = m.reaction;
      reaction.style.display = "inline-flex";
    }
    bubble.appendChild(reaction);

    row.appendChild(bubble);
    threadEl.appendChild(row);
  }
}

function scrollToBottom(){
  const chat = document.getElementById("chat");
  chat.scrollTop = chat.scrollHeight;
}

/* typing then show */
const typingRow = document.getElementById('typingRow');
typingRow.style.display = 'flex';

setTimeout(() => {
  typingRow.style.display = 'none';
  renderThread();
  scrollToBottom();
  setTimeout(() => ta.focus(), 150);
}, 450);

/* =======================
   SEND: show outgoing bubble + POST to Make
======================= */
const form = document.getElementById("smsForm");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const text = (ta.value || "").trim();
  if (!text) return;

  // Show outgoing bubble instantly
  messages.push({ id: cryptoRandomId(), dir: "out", text, ts: new Date(), reaction: "" });
  renderThread();
  scrollToBottom();

  // Clear input
  ta.value = "";
  ta.style.height = "auto";

  // POST to Make in background
  try {
    const fd = new FormData(form);
    fd.set("body", text);

    await fetch(form.action, {
      method: "POST",
      body: fd,
      mode: "no-cors"
    });
  } catch (err) {
    console.error(err);
  }
});

/* =======================
   TAPBACK (LONG PRESS)
======================= */
const overlay = document.getElementById("overlay");
const tapback = document.getElementById("tapback");

let pressTimer = null;
let activeBubbleId = null;

function openTapbackForBubble(bubbleEl){
  activeBubbleId = bubbleEl.dataset.id;
  overlay.style.display = "block";
  tapback.style.display = "inline-flex";
  tapback.animate(
    [{ transform:"translateX(-50%) scale(.98)", opacity:.0 }, { transform:"translateX(-50%) scale(1)", opacity:1 }],
    { duration:140, easing:"ease-out" }
  );
}
function closeTapback(){
  overlay.style.display = "none";
  tapback.style.display = "none";
  activeBubbleId = null;
}
overlay.addEventListener("click", closeTapback);

tapback.addEventListener("click", (e) => {
  const btn = e.target.closest("button");
  if (!btn || !activeBubbleId) return;

  const reaction = btn.getAttribute("data-reaction") || "";
  const msgObj = messages.find(x => x.id === activeBubbleId);
  if (msgObj){
    msgObj.reaction = reaction;
    renderThread();
    scrollToBottom();
  }
  closeTapback();
});

document.addEventListener("pointerdown", (e) => {
  const bubble = e.target.closest(".bubble");
  if (!bubble) return;

  clearTimeout(pressTimer);
  pressTimer = setTimeout(() => openTapbackForBubble(bubble), 420);
});
document.addEventListener("pointerup", () => clearTimeout(pressTimer));
document.addEventListener("pointercancel", () => clearTimeout(pressTimer));
document.addEventListener("scroll", () => clearTimeout(pressTimer), { passive:true });
</script>

</body>
</html>
